format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: flutter

trigger_map:
- push_branch: main
  workflow: android_firebase
- pull_request_source_branch: "*"
  workflow: android_firebase

workflows:
  
  android_firebase:
    description: Build Android APK and deploy to Firebase App Distribution
    
    steps:
    
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
        title: Activate SSH key for Git
    
    - git-clone@8:
        title: Clone repository
    
    - flutter-installer@0:
        title: Install Flutter SDK
        inputs:
        - version: master
        - is_update: 'false'
    
    - restore-dart-cache@2:
        title: Restore Dart packages cache
    
    - script@1:
        title: Setup Firebase configuration files
        is_always_run: false
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cd voteeasy
            
            echo "Creating Firebase configuration files..."
            
            if [ -n "$GOOGLE_SERVICES_JSON" ]; then
                echo "$GOOGLE_SERVICES_JSON" > android/app/google-services.json
                echo "google-services.json created"
            else
                echo "WARNING: GOOGLE_SERVICES_JSON secret is not set!"
                echo "Please add it in Bitrise Secrets:"
                echo "1. Go to Workflow Editor > Secrets"
                echo "2. Add new secret:"
                echo "   Key: GOOGLE_SERVICES_JSON"
                echo "   Value: <paste content of voteeasy/android/app/google-services.json>"
                echo ""
                echo "Checking if google-services.json exists in repo..."
                if [ -f "android/app/google-services.json" ]; then
                    echo "Found google-services.json in repository"
                else
                    echo "ERROR: google-services.json not found!"
                    exit 1
                fi
            fi
            
            if [ -n "$FIREBASE_OPTIONS_DART" ]; then
                echo "$FIREBASE_OPTIONS_DART" > lib/firebase_options.dart
                echo "firebase_options.dart created"
            else
                echo "WARNING: FIREBASE_OPTIONS_DART secret is not set!"
                echo "Please add it in Bitrise Secrets:"
                echo "1. Go to Workflow Editor > Secrets"
                echo "2. Add new secret:"
                echo "   Key: FIREBASE_OPTIONS_DART"
                echo "   Value: <paste content of voteeasy/lib/firebase_options.dart>"
                echo ""
                echo "Checking if firebase_options.dart exists in repo..."
                if [ -f "lib/firebase_options.dart" ]; then
                    echo "Found firebase_options.dart in repository"
                else
                    echo "ERROR: firebase_options.dart not found!"
                    exit 1
                fi
            fi
    
    - script@1:
        title: Flutter packages get
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cd voteeasy
            echo "Installing Flutter dependencies..."
            flutter pub get
            
            echo "Dependencies installed successfully"
    
    - script@1:
        title: Flutter analyze
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cd voteeasy
            echo "Running Flutter analyze..."
            flutter analyze --no-fatal-infos || true
            
            echo "Code analysis completed"
    
    - save-dart-cache@1:
        title: Save Dart packages cache
    
    - script@1:
        title: Build Android APK (Release)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cd voteeasy
            echo "Building Flutter Android APK in RELEASE mode..."
            echo "Project: VoteEasy"
            echo "Branch: $BITRISE_GIT_BRANCH"
            echo "Build Number: $BITRISE_BUILD_NUMBER"
            
            flutter build apk --release
            
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
            
            if [ -f "$APK_PATH" ]; then
                echo "APK built successfully!"
                echo "Path: $APK_PATH"
                ls -lh "$APK_PATH"
                
                envman add --key ANDROID_APK_PATH --value "$BITRISE_SOURCE_DIR/voteeasy/$APK_PATH"
                
                cp "$APK_PATH" "$BITRISE_DEPLOY_DIR/VoteEasy-$BITRISE_BUILD_NUMBER.apk"
                echo "APK copied to artifacts as VoteEasy-$BITRISE_BUILD_NUMBER.apk"
            else
                echo "APK not found at expected path!"
                echo "Searching for APK files..."
                find . -name "*.apk" -type f
                exit 1
            fi
    
    - script@1:
        title: Verify Firebase configuration
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "Verifying Firebase configuration..."
            echo "App ID: $FIREBASE_APP_ID_ANDROID"
            echo "APK Path: $ANDROID_APK_PATH"
            
            if [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
                echo "ERROR: FIREBASE_APP_ID_ANDROID is not set!"
                echo "To fix this, add the following Secret in Bitrise:"
                echo "Key: FIREBASE_APP_ID_ANDROID"
                echo "Value: 1:768252539367:android:3d680b29de0c2cbe4a0d42"
                exit 1
            fi
            
            if [ -z "$FIREBASE_TOKEN" ]; then
                echo "ERROR: FIREBASE_TOKEN is not set!"
                echo "To generate a token, run locally: firebase login:ci"
                exit 1
            fi
            
            if [ ! -f "$ANDROID_APK_PATH" ]; then
                echo "ERROR: APK file not found at $ANDROID_APK_PATH"
                exit 1
            fi
            
            echo "Firebase configuration verified successfully"
    
    - script@1:
        title: Deploy to Firebase App Distribution
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "Uploading to Firebase App Distribution..."
            echo "App: VoteEasy"
            echo "APK: $ANDROID_APK_PATH"
            echo "App ID: $FIREBASE_APP_ID_ANDROID"
            echo "Branch: $BITRISE_GIT_BRANCH"
            echo "Build: #$BITRISE_BUILD_NUMBER"
            
            echo "Installing Firebase CLI..."
            npm install -g firebase-tools
            firebase --version
            
            RELEASE_NOTES="VoteEasy Build #$BITRISE_BUILD_NUMBER - Branch: $BITRISE_GIT_BRANCH - Commit: ${GIT_CLONE_COMMIT_HASH:0:8}"
            
            echo "Starting upload..."
            firebase appdistribution:distribute "$ANDROID_APK_PATH" \
              --app "$FIREBASE_APP_ID_ANDROID" \
              --token "$FIREBASE_TOKEN" \
              --groups "testers" \
              --release-notes "$RELEASE_NOTES"
            
            if [ $? -eq 0 ]; then
                echo "Successfully uploaded to Firebase App Distribution!"
                echo "Testers in 'testers' group will receive an email notification"
            else
                echo "Firebase upload failed!"
                exit 1
            fi
    
    - script@1:
        title: Create installation instructions
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cat > "$BITRISE_DEPLOY_DIR/README.txt" << 'EOF'
            VoteEasy Android Build
            
            APK File: VoteEasy-BUILD_NUMBER.apk
            
            Installation Options:
            
            1. Firebase App Distribution (Recommended)
               - Check your email for the Firebase invitation
               - Install Firebase App Tester from Play Store
               - Open the app and sign in
               - Download and install the latest build
            
            2. Direct APK Install
               - Download the APK file
               - On Android: Settings > Security > Unknown sources ON
               - Open the APK file and tap Install
            
            3. ADB Install (Developers)
               - adb install VoteEasy.apk
            
            Features:
            - Create and manage polls
            - Vote on polls
            - Real-time results
            - Firebase Cloud sync
            EOF
            
            echo "Installation instructions created"
    
    - deploy-to-bitrise-io@2:
        title: Deploy build artifacts
        inputs:
        - notify_user_groups: none
        - is_compress: 'false'

app:
  envs:
  - BITRISE_FLUTTER_PROJECT_LOCATION: "voteeasy"
    opts:
      is_expand: false
  - FLUTTER_VERSION: master
    opts:
      is_expand: false

meta:
  bitrise.io:
    stack: linux-docker-android-22.04
