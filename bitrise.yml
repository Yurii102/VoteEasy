---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: flutter

trigger_map:
- push_branch: main
  workflow: android_firebase
- pull_request_source_branch: "*"
  workflow: android_firebase

# ============================================
# WORKFLOWS
# ============================================
workflows:
  
  # ------------------------------------------
  # ANDROID BUILD + FIREBASE APP DISTRIBUTION
  # ------------------------------------------
  android_firebase:
    description: |
      Build Android APK та deploy на Firebase App Distribution.
      ÷ей workflow виконуЇ:
      1.  лонуванн€ репозитор≥ю
      2. ¬становленн€ Flutter SDK
      3. јнал≥з коду (flutter analyze)
      4. Build Release APK
      5. Upload на Firebase App Distribution
    
    steps:
    
    # ========== STEP 1: Activate SSH Key ==========
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
        title: Activate SSH key for Git
    
    # ========== STEP 2: Clone Repository ==========
    - git-clone@8:
        title: Clone repository
    
    # ========== STEP 3: Install Flutter ==========
    - flutter-installer@0:
        title: Install Flutter SDK
        inputs:
        - version: master
        - is_update: 'false'
    
    # ========== STEP 4: Restore Dart Cache ==========
    - restore-dart-cache@2:
        title: Restore Dart packages cache
    
    # ========== STEP 5: Setup Firebase Config ==========
    - script@1:
        title: Setup Firebase configuration files
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cd voteeasy
            
            echo "?? Creating Firebase configuration files..."
            
            # —творюЇмо google-services.json з секрету
            if [ -n "$GOOGLE_SERVICES_JSON" ]; then
                echo "$GOOGLE_SERVICES_JSON" > android/app/google-services.json
                echo "? google-services.json created"
            else
                echo "? GOOGLE_SERVICES_JSON secret is not set!"
                exit 1
            fi
            
            # —творюЇмо firebase_options.dart з секрету
            if [ -n "$FIREBASE_OPTIONS_DART" ]; then
                echo "$FIREBASE_OPTIONS_DART" > lib/firebase_options.dart
                echo "? firebase_options.dart created"
            else
                echo "? FIREBASE_OPTIONS_DART secret is not set!"
                exit 1
            fi
    
    # ========== STEP 6: Flutter Pub Get ==========
    - script@1:
        title: Flutter packages get
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cd voteeasy
            echo "?? Installing Flutter dependencies..."
            flutter pub get
            
            echo "? Dependencies installed successfully"
    
    # ========== STEP 7: Flutter Analyze ==========
    - script@1:
        title: Flutter analyze (code quality check)
        inputs:
        - content: |-
            #!/usr:bin/env bash
            set -e
            
            cd voteeasy
            echo "?? Running Flutter analyze..."
            flutter analyze --no-fatal-infos || true
            
            echo "? Code analysis completed"
    
    # ========== STEP 8: Save Dart Cache ==========
    - save-dart-cache@1:
        title: Save Dart packages cache
    
    # ========== STEP 9: Build Android APK ==========
    - script@1:
        title: Build Android APK (Release)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cd voteeasy
            echo "?? Building Flutter Android APK in RELEASE mode..."
            echo "Project: VoteEasy"
            echo "Branch: $BITRISE_GIT_BRANCH"
            echo "Build Number: $BITRISE_BUILD_NUMBER"
            
            # Build release APK
            flutter build apk --release
            
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
            
            if [ -f "$APK_PATH" ]; then
                echo "? APK built successfully!"
                echo "?? Path: $APK_PATH"
                ls -lh "$APK_PATH"
                
                # Export path for Firebase step
                envman add --key ANDROID_APK_PATH --value "$BITRISE_SOURCE_DIR/voteeasy/$APK_PATH"
                
                # Copy to deploy directory with proper name
                cp "$APK_PATH" "$BITRISE_DEPLOY_DIR/VoteEasy-$BITRISE_BUILD_NUMBER.apk"
                echo "? APK copied to artifacts as VoteEasy-$BITRISE_BUILD_NUMBER.apk"
            else
                echo "? APK not found at expected path!"
                echo "Searching for APK files..."
                find . -name "*.apk" -type f
                exit 1
            fi
    
    # ========== STEP 10: Verify Firebase Configuration ==========
    - script@1:
        title: Verify Firebase configuration
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "?? Verifying Firebase configuration..."
            echo "======================================="
            echo "App ID: $FIREBASE_APP_ID_ANDROID"
            echo "APK Path: $ANDROID_APK_PATH"
            echo "======================================="
            
            if [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
                echo "? ERROR: FIREBASE_APP_ID_ANDROID is not set!"
                echo ""
                echo "?? To fix this, add the following Secret in Bitrise:"
                echo "   Key: FIREBASE_APP_ID_ANDROID"
                echo "   Value: 1:768252539367:android:3d680b29de0c2cbe4a0d42"
                echo ""
                echo "You can find this in Firebase Console > Project Settings > Your apps"
                exit 1
            fi
            
            if [ -z "$FIREBASE_TOKEN" ]; then
                echo "? ERROR: FIREBASE_TOKEN is not set!"
                echo ""
                echo "?? To generate a token, run locally:"
                echo "   firebase login:ci"
                echo ""
                echo "Then add the token as a Secret in Bitrise:"
                echo "   Key: FIREBASE_TOKEN"
                echo "   Value: <your-token>"
                exit 1
            fi
            
            if [ ! -f "$ANDROID_APK_PATH" ]; then
                echo "? ERROR: APK file not found at $ANDROID_APK_PATH"
                exit 1
            fi
            
            echo "? Firebase configuration verified successfully"
    
    # ========== STEP 11: Firebase App Distribution ==========
    - script@1:
        title: Deploy to Firebase App Distribution
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "?? Uploading to Firebase App Distribution..."
            echo "============================================"
            echo "?? App: VoteEasy"
            echo "?? APK: $ANDROID_APK_PATH"
            echo "?? App ID: $FIREBASE_APP_ID_ANDROID"
            echo "?? Branch: $BITRISE_GIT_BRANCH"
            echo "?? Build: #$BITRISE_BUILD_NUMBER"
            echo "============================================"
            
            # Install Firebase CLI
            echo "?? Installing Firebase CLI..."
            npm install -g firebase-tools
            firebase --version
            
            # Create release notes
            RELEASE_NOTES="VoteEasy Build #$BITRISE_BUILD_NUMBER
            
            Branch: $BITRISE_GIT_BRANCH
            Commit: ${GIT_CLONE_COMMIT_HASH:0:8}
            Date: $(date '+%Y-%m-%d %H:%M:%S')
            
            Changes: $GIT_CLONE_COMMIT_MESSAGE_SUBJECT"
            
            echo "?? Release notes:"
            echo "$RELEASE_NOTES"
            echo ""
            
            # Upload to Firebase App Distribution
            echo "?? Starting upload..."
            firebase appdistribution:distribute "$ANDROID_APK_PATH" \
              --app "$FIREBASE_APP_ID_ANDROID" \
              --token "$FIREBASE_TOKEN" \
              --groups "testers" \
              --release-notes "$RELEASE_NOTES"
            
            if [ $? -eq 0 ]; then
                echo ""
                echo "? Successfully uploaded to Firebase App Distribution!"
                echo "?? Testers in 'testers' group will receive an email notification"
            else
                echo "? Firebase upload failed!"
                exit 1
            fi
    
    # ========== STEP 12: Create Installation Instructions ==========
    - script@1:
        title: Create installation instructions
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cat > "$BITRISE_DEPLOY_DIR/README.txt" << EOF
            ????????????????????????????????????????????????????????????????
            ?              ??? VoteEasy - Build Info                        ?
            ????????????????????????????????????????????????????????????????
            ?                                                              ?
            ?  ?? APK File: VoteEasy-$BITRISE_BUILD_NUMBER.apk                               ?
            ?  ?? Branch: $BITRISE_GIT_BRANCH                                       ?
            ?  ?? Build Number: $BITRISE_BUILD_NUMBER                                ?
            ?  ?? Build Date: $(date '+%Y-%m-%d %H:%M:%S')                     ?
            ?                                                              ?
            ????????????????????????????????????????????????????????????????
            ?                    ?? INSTALLATION OPTIONS                   ?
            ????????????????????????????????????????????????????????????????
            ?                                                              ?
            ?  OPTION 1: Firebase App Distribution (Recommended)           ?
            ?  ??????????????????????????????????????????????????????????  ?
            ?  1. Check your email for the Firebase invitation             ?
            ?  2. Install "Firebase App Tester" from Play Store            ?
            ?  3. Open the app and sign in                                 ?
            ?  4. Download and install the latest build                    ?
            ?                                                              ?
            ?  OPTION 2: Direct APK Install                                ?
            ?  ??????????????????????????????????????????????????????????  ?
            ?  1. Download VoteEasy-$BITRISE_BUILD_NUMBER.apk                               ?
            ?  2. On Android: Settings > Security > Unknown sources ON     ?
            ?  3. Open the APK file and tap "Install"                      ?
            ?                                                              ?
            ?  OPTION 3: ADB Install (Developers)                          ?
            ?  ??????????????????????????????????????????????????????????  ?
            ?  adb install VoteEasy-$BITRISE_BUILD_NUMBER.apk                               ?
            ?                                                              ?
            ????????????????????????????????????????????????????????????????
            ?                       ?? FEATURES                            ?
            ????????????????????????????????????????????????????????????????
            ?  Х Create and manage polls                                   ?
            ?  Х Vote on polls                                             ?
            ?  Х Real-time results                                         ?
            ?  Х Firebase Cloud sync                                       ?
            ?  Х Beautiful Material Design UI                              ?
            ????????????????????????????????????????????????????????????????
            EOF
            
            echo "? Installation instructions created"
    
    # ========== STEP 13: Deploy Artifacts ==========
    - deploy-to-bitrise-io@2:
        title: Deploy build artifacts
        inputs:
        - notify_user_groups: none
        - is_compress: 'false'

# ============================================
# APP ENVIRONMENT VARIABLES
# ============================================
app:
  envs:
  - BITRISE_FLUTTER_PROJECT_LOCATION: "voteeasy"
    opts:
      is_expand: false
  - FLUTTER_VERSION: master
    opts:
      is_expand: false

meta:
  bitrise.io:
    stack: linux-docker-android-22.04
